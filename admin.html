<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - 44g store</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="templatemo-606-string-master.css">
  <style>
    .admin-panel {
      padding: 8rem 2rem 4rem;
    }
    .admin-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 2rem;
    }
    .admin-table th, .admin-table td {
      padding: 1rem;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    .admin-table th {
      color: var(--text-secondary);
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .admin-table td {
      font-size: 0.95rem;
    }
    .admin-table tr:last-child td {
      border-bottom: none;
    }
    .admin-table tr:hover {
      background-color: rgba(255, 255, 255, 0.02);
    }
    .admin-table tr.is-read td {
        color: var(--text-muted);
        opacity: 0.7;
    }
    .status-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 100px;
      font-size: 0.8rem;
      font-weight: 600;
    }
    .status-active {
      background: rgba(34, 197, 94, 0.15);
      color: #22c55e;
    }
    .status-pending {
      background: rgba(245, 158, 11, 0.15);
      color: var(--accent);
    }
    #login-view, #admin-dashboard {
      display: none; /* Hidden by default */
    }
    .login-form {
      max-width: 400px;
      margin: 4rem auto;
      padding: 2.5rem;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 20px;
    }
    .login-form input {
      width: 100%;
      padding: 1rem;
      margin-bottom: 1rem;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text-primary);
      font-family: inherit;
      font-size: 1rem;
    }
    .login-form .btn-primary {
      width: 100%;
      justify-content: center;
    }
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }
    .form-group {
      display: flex;
      flex-direction: column;
    }
    .form-group label {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 0.5rem;
    }
    .form-group input, .form-group select {
      width: 100%;
      padding: 0.75rem;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-primary);
      font-family: inherit;
      font-size: 0.95rem;
    }
    .btn-delete {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
        border: 1px solid rgba(239, 68, 68, 0.3);
        padding: 0.4rem 0.8rem;
        border-radius: 6px;
        font-size: 0.8rem;
        font-family: inherit;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.15s;
    }
    .btn-delete:hover {
        background: #ef4444;
        color: var(--text-primary);
        border-color: #ef4444;
    }
    .btn-edit {
        background: rgba(59, 130, 246, 0.1);
        color: #3b82f6;
        border: 1px solid rgba(59, 130, 246, 0.3);
        padding: 0.4rem 0.8rem;
        border-radius: 6px;
        font-size: 0.8rem;
        font-family: inherit;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.15s;
        margin-right: 0.5rem;
    }
    .btn-edit:hover {
        background: #3b82f6;
        color: var(--text-primary);
        border-color: #3b82f6;
    }
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(5px);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }
    .modal-content {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 20px;
        padding: 2rem;
        width: 90%;
        max-width: 600px;
        position: relative;
    }
    .modal-close-btn {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: none;
        border: none;
        color: var(--text-muted);
        font-size: 1.5rem;
        cursor: pointer;
        line-height: 1;
        padding: 0.5rem;
    }
    .modal-close-btn:hover {
        color: var(--text-primary);
    }
    .admin-tabs {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 3rem;
        background: var(--bg-card);
        padding: 0.5rem;
        border-radius: 12px;
        border: 1px solid var(--border);
    }
    .admin-tabs a {
        display: block;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        color: var(--text-secondary);
        text-decoration: none;
        font-weight: 500;
        transition: all 0.2s;
    }
    .admin-tabs a:hover {
        color: var(--text-primary);
    }
    .admin-tabs a.active {
        background: var(--accent);
        color: var(--bg-dark);
        font-weight: 600;
    }
    .content-section {
        display: none;
    }
    .content-section.active {
        display: block;
    }
  </style>
</head>
<body>

  <!-- Navigation -->
  <nav>
    <div class="nav-container">
      <a href="index.html" class="logo">
        <div class="logo-icon">44g</div>
        Admin Panel
      </a>
      <ul class="nav-links">
        <li><a href="index.html">Home</a></li>
        <li><a href="#" id="logout-btn" style="display: none;">Logout</a></li>
      </ul>
    </div>
  </nav>

  <!-- Login View -->
  <section id="login-view" class="admin-panel">
    <div class="login-form">
        <h2 class="section-title" style="text-align: center; margin-bottom: 2rem;">Admin Login</h2>
        <input type="email" id="email" placeholder="Email" required>
        <input type="password" id="password" placeholder="Password" required>
        <button id="login-btn" class="btn-primary">Login</button>
        <p id="login-error" style="color: #ef4444; text-align: center; margin-top: 1rem;"></p>
    </div>
  </section>

  <!-- Admin Dashboard -->
  <section id="admin-dashboard" class="admin-panel">
    <div class="section-container">
      <div class="admin-tabs" id="admin-nav">
        <a href="#" class="active" data-target="dashboard-content">Dashboard</a>
        <a href="#" data-target="orders-content">Orders</a>
        <a href="#" data-target="products-content">Products</a>
        <a href="#" data-target="content-content">Site Content</a>
        <a href="#" data-target="messages-content">Messages</a>
        <a href="#" data-target="free-configs-content">Free Configs</a>
        <a href="#" data-target="settings-content">Settings</a>
      </div>

      <main class="admin-content">
        <!-- Dashboard Section -->
        <div id="dashboard-content" class="content-section active">
          <h2 class="section-title" style="text-align: left; margin-bottom: 2rem;">Dashboard</h2>
          <div class="features-grid">
            <div class="feature-card"><h3>Total Users</h3><p class="stat-value" id="total-users-stat">0</p></div>
            <div class="feature-card"><h3>Revenue (Month)</h3><p class="stat-value" id="monthly-revenue-stat">LKR 0</p></div>
            <div class="feature-card"><h3>Active Subscriptions</h3><p class="stat-value" id="active-subs-stat">0</p></div>
          </div>
        </div>

        <!-- Orders Section -->
        <div id="orders-content" class="content-section">
          <h2 class="section-title" style="text-align: left; margin-bottom: 2rem;">Orders</h2>
          <div class="pricing-card" style="padding: 2rem; margin-bottom: 2rem;">
            <h3 style="margin-bottom: 1.5rem;">Add New Order</h3>
            <form id="add-order-form">
              <div class="form-group" style="margin-bottom: 1rem;">
                <label for="order-email">User Email</label>
                <input type="email" id="order-email" placeholder="user@example.com" required>
              </div>
              <div class="form-grid">
                <div class="form-group">
                  <label for="order-plan">Plan</label>
                  <select id="order-plan">
                    <option value="Basic SG V2Ray">Basic SG V2Ray</option>
                    <option value="Pro SG V2Ray" selected>Pro SG V2Ray</option>
                    <option value="Business SG V2Ray">Business SG V2Ray</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="order-amount">Amount (LKR)</label>
                  <input type="number" id="order-amount" value="2700" required>
                </div>
              </div>
              <button type="submit" class="btn-primary" style="width: 100%; margin-top: 2rem;">Add Order</button>
              <p id="add-order-status" style="text-align: center; margin-top: 1rem;"></p>
            </form>
          </div>
          <div class="pricing-card" style="padding: 1rem;">
            <h3 style="margin-bottom: 1.5rem; padding: 1rem;">Recent Orders</h3>
            <table class="admin-table">
              <thead>
                <tr><th>Order ID</th><th>User Email</th><th>Plan</th><th>Amount</th><th>Status</th><th>Actions</th></tr>
              </thead>
              <tbody id="orders-table-body"></tbody>
            </table>
          </div>
        </div>

        <!-- Products Section -->
        <div id="products-content" class="content-section">
          <h2 class="section-title" style="text-align: left; margin-bottom: 2rem;">Products</h2>
          <div class="pricing-card" style="padding: 2rem; margin-bottom: 2rem;">
            <h3 style="margin-bottom: 1.5rem;">Add New Product</h3>
            <form id="add-product-form">
              <div class="form-grid">
                <div class="form-group">
                  <label for="product-name">Product Name</label>
                  <input type="text" id="product-name" placeholder="e.g., Pro V2Ray SG Plan" required>
                </div>
                <div class="form-group">
                  <label for="product-price">Price (LKR/mo)</label>
                  <input type="number" id="product-price" placeholder="e.g., 2700" required>
                </div>
              </div>
              <div class="form-group" style="margin-top: 1rem;">
                <label for="product-description">Description</label>
                <input type="text" id="product-description" placeholder="A short description of the V2Ray plan." required>
              </div>
              <div class="form-group" style="margin-top: 1rem;">
                <label for="product-features">Features (one per line)</label>
                <textarea id="product-features" rows="4" placeholder="Feature 1&#10;Feature 2&#10;Feature 3" style="padding: 0.75rem; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-family: inherit; font-size: 0.95rem; width: 100%; resize: vertical;"></textarea>
              </div>
              <div class="form-group" style="margin-top: 1rem;">
                <label for="product-image-url">Product Image URL (Optional)</label>
                <input type="url" id="product-image-url" placeholder="https://example.com/image.jpg">
              </div>
              <button type="submit" class="btn-primary" style="width: 100%; margin-top: 2rem;">Add Product</button>
              <p id="add-product-status" style="text-align: center; margin-top: 1rem;"></p>
            </form>
          </div>
          <div class="pricing-card" style="padding: 1rem;">
            <h3 style="margin-bottom: 1.5rem; padding: 1rem;">Manage Products</h3>
            <table class="admin-table">
              <thead>
                <tr><th>Product Name</th><th>Price (LKR)</th><th>Actions</th></tr>
              </thead>
              <tbody id="products-table-body"></tbody>
            </table>
          </div>
        </div>

        <!-- Site Content Section -->
        <div id="content-content" class="content-section">
          <h2 class="section-title" style="text-align: left; margin-bottom: 2rem;">Site Content</h2>
          <div class="pricing-card" style="padding: 2rem; margin-bottom: 2rem;">
            <h3 style="margin-bottom: 1.5rem;">Manage Testimonials</h3>
            <form id="add-testimonial-form">
              <div class="form-group" style="margin-bottom: 1rem;">
                <label for="testimonial-text">Testimonial Text</label>
                <textarea id="testimonial-text" rows="3" required style="padding: 0.75rem; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-family: inherit; font-size: 0.95rem; width: 100%; resize: vertical;"></textarea>
              </div>
              <div class="form-grid">
                <div class="form-group">
                  <label for="testimonial-author">Author Name</label>
                  <input type="text" id="testimonial-author" placeholder="e.g., Nimal P." required>
                </div>
                <div class="form-group">
                  <label for="testimonial-location">Author Location/Title</label>
                  <input type="text" id="testimonial-location" placeholder="e.g., User from Colombo" required>
                </div>
                <div class="form-group">
                  <label for="testimonial-rating">Rating (1-5 Stars)</label>
                  <select id="testimonial-rating">
                      <option value="5" selected>5 Stars</option><option value="4">4 Stars</option><option value="3">3 Stars</option><option value="2">2 Stars</option><option value="1">1 Star</option>
                  </select>
                </div>
              </div>
              <div class="form-group" style="margin-top: 1rem;">
                <label for="testimonial-image-url">Author Image URL (Optional)</label>
                <input type="url" id="testimonial-image-url" placeholder="https://example.com/image.jpg">
              </div>
              <button type="submit" class="btn-primary" style="width: 100%; margin-top: 2rem;">Add Testimonial</button>
              <p id="add-testimonial-status" style="text-align: center; margin-top: 1rem;"></p>
            </form>
            <table class="admin-table" style="margin-top: 2rem;">
              <thead><tr><th>Author</th><th style="width: 60%;">Testimonial</th><th>Actions</th></tr></thead>
              <tbody id="testimonials-table-body"></tbody>
            </table>
          </div>
          <div class="pricing-card" style="padding: 2rem; margin-bottom: 2rem;">
            <h3 style="margin-bottom: 1.5rem;">Manage Team</h3>
            <form id="add-team-member-form">
              <div class="form-grid">
                <div class="form-group">
                  <label for="team-member-name">Member Name</label>
                  <input type="text" id="team-member-name" placeholder="e.g., John Doe" required>
                </div>
                <div class="form-group">
                  <label for="team-member-role">Role</label>
                  <input type="text" id="team-member-role" placeholder="e.g., Founder & CEO" required>
                </div>
              </div>
              <div class="form-group" style="margin-top: 1rem;">
                <label for="team-member-bio">Bio</label>
                <input type="text" id="team-member-bio" placeholder="A short bio." required>
              </div>
              <div class="form-group" style="margin-top: 1rem;">
                <label for="team-member-image-url">Image URL</label>
                <input type="url" id="team-member-image-url" placeholder="https://example.com/image.jpg" required>
              </div>
              <button type="submit" class="btn-primary" style="width: 100%; margin-top: 2rem;">Add Team Member</button>
              <p id="add-team-member-status" style="text-align: center; margin-top: 1rem;"></p>
            </form>
            <table class="admin-table" style="margin-top: 2rem;">
              <thead><tr><th>Name</th><th>Role</th><th>Actions</th></tr></thead>
              <tbody id="team-members-table-body"></tbody>
            </table>
          </div>
        </div>

        <!-- Messages Section -->
        <div id="messages-content" class="content-section">
          <h2 class="section-title" style="text-align: left; margin-bottom: 2rem;">Contact Messages</h2>
          <div class="pricing-card" style="padding: 1rem;">
            <table class="admin-table">
              <thead>
                <tr><th>From</th><th>Email</th><th style="width: 50%;">Message</th><th>Actions</th></tr>
              </thead>
              <tbody id="messages-table-body"></tbody>
            </table>
          </div>
        </div>

        <!-- Free Configs Section -->
        <div id="free-configs-content" class="content-section">
          <h2 class="section-title" style="text-align: left; margin-bottom: 2rem;">Free V2Ray Configs</h2>
          <div class="pricing-card" style="padding: 2rem; margin-bottom: 2rem;">
            <h3 style="margin-bottom: 1.5rem;">Add New Free Config</h3>
            <form id="add-free-config-form">
              <div class="form-group" style="margin-bottom: 1rem;">
                <label for="free-config-name">Config Name</label>
                <input type="text" id="free-config-name" placeholder="e.g., SG Server 1 (Trial)" required>
              </div>
              <div class="form-group" style="margin-bottom: 1rem;">
                <label for="free-config-desc">Description</label>
                <input type="text" id="free-config-desc" placeholder="e.g., Limited to 5Mbps for 24 hours." required>
              </div>
              <div class="form-group" style="margin-bottom: 1rem;">
                <label for="free-config-url">V2Ray Config URL</label>
                <input type="text" id="free-config-url" placeholder="vless://..." required>
              </div>
              <button type="submit" class="btn-primary" style="width: 100%; margin-top: 2rem;">Add Free Config</button>
              <p id="add-free-config-status" style="text-align: center; margin-top: 1rem;"></p>
            </form>
          </div>
          <div class="pricing-card" style="padding: 1rem;">
            <h3 style="margin-bottom: 1.5rem; padding: 1rem;">Manage Free Configs</h3>
            <table class="admin-table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="free-configs-table-body"></tbody>
            </table>
          </div>
        </div>

        <!-- Settings Section -->
        <div id="settings-content" class="content-section">
          <h2 class="section-title" style="text-align: left; margin-bottom: 2rem;">Settings</h2>
          <div class="pricing-card" style="padding: 2rem;">
            <h3 style="margin-bottom: 1.5rem;">Store Settings</h3>
            <form id="settings-form">
              <div class="form-group">
                <label for="whatsapp-number">Your WhatsApp Number</label>
                <input type="text" id="whatsapp-number" placeholder="e.g., 94771234567" required>
                <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem;">Include country code, no '+' or '00'.</p>
              </div>
              <button type="submit" class="btn-primary" style="width: 100%; margin-top: 1rem;">Save Settings</button>
              <p id="settings-status" style="text-align: center; margin-top: 1rem;"></p>
            </form>
          </div>
        </div>
      </main>
    </div>
  </section>

  <!-- Edit Free Config Modal -->
  <div id="edit-free-config-modal" class="modal-overlay">
    <div class="modal-content">
      <button id="free-config-modal-close-btn" class="modal-close-btn">&times;</button>
      <h2 class="section-title" style="font-size: 2rem; text-align: left; margin-bottom: 2rem;">Edit Free Config</h2>
      <form id="edit-free-config-form">
        <input type="hidden" id="edit-free-config-key">
        <div class="form-group" style="margin-bottom: 1rem;">
          <label for="edit-free-config-name">Config Name</label>
          <input type="text" id="edit-free-config-name" required>
        </div>
        <div class="form-group" style="margin-bottom: 1rem;">
          <label for="edit-free-config-desc">Description</label>
          <input type="text" id="edit-free-config-desc" required>
        </div>
        <div class="form-group" style="margin-bottom: 1rem;">
          <label for="edit-free-config-url">V2Ray Config URL</label>
          <input type="text" id="edit-free-config-url" required>
        </div>
        <button type="submit" class="btn-primary" style="width: 100%; margin-top: 2rem;">Update Free Config</button>
        <p id="edit-free-config-status" style="text-align: center; margin-top: 1rem;"></p>
      </form>
    </div>
  </div>

  <!-- Edit Order Modal -->
  <div id="edit-order-modal" class="modal-overlay">
    <div class="modal-content">
      <button id="order-modal-close-btn" class="modal-close-btn">&times;</button>
      <h2 class="section-title" style="font-size: 2rem; text-align: left; margin-bottom: 2rem;">Edit Order</h2>
      <form id="edit-order-form">
        <input type="hidden" id="edit-order-key">
        <div class="form-group" style="margin-bottom: 1rem;">
          <label for="edit-order-id">Order ID</label>
          <input type="text" id="edit-order-id" readonly style="background: var(--bg-dark); color: var(--text-muted);">
        </div>
        <div class="form-grid">
          <div class="form-group">
            <label for="edit-order-email">User Email</label>
            <input type="email" id="edit-order-email" required>
          </div>
          <div class="form-group">
            <label for="edit-order-status-select">Status</label>
            <select id="edit-order-status-select">
                <option value="pending">Pending</option>
                <option value="active">Active</option>
                <option value="cancelled">Cancelled</option>
            </select>
          </div>
        </div>
        <div class="form-group" style="margin-top: 1rem;">
            <label for="edit-order-amount">Amount (LKR)</label>
            <input type="number" id="edit-order-amount" required>
        </div>
        <button type="submit" class="btn-primary" style="width: 100%; margin-top: 2rem;">Update Order</button>
        <p id="update-order-status" style="text-align: center; margin-top: 1rem;"></p>
      </form>
        </div>
      </div>
    </div>
  </section>

  <!-- Edit Testimonial Modal -->
  <div id="edit-testimonial-modal" class="modal-overlay">
    <div class="modal-content">
      <button id="testimonial-modal-close-btn" class="modal-close-btn">&times;</button>
      <h2 class="section-title" style="font-size: 2rem; text-align: left; margin-bottom: 2rem;">Edit Testimonial</h2>
      <form id="edit-testimonial-form">
        <input type="hidden" id="edit-testimonial-key">
        <div class="form-group" style="margin-bottom: 1rem;">
          <label for="edit-testimonial-text">Testimonial Text</label>
          <textarea id="edit-testimonial-text" rows="4" required style="padding: 0.75rem; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-family: inherit; font-size: 0.95rem; width: 100%; resize: vertical;"></textarea>
        </div>
        <div class="form-grid">
          <div class="form-group">
            <label for="edit-testimonial-author">Author Name</label>
            <input type="text" id="edit-testimonial-author" required>
          </div>
          <div class="form-group">
            <label for="edit-testimonial-location">Author Location/Title</label>
            <input type="text" id="edit-testimonial-location" required>
          </div>
          <div class="form-group">
            <label for="edit-testimonial-rating">Rating (1-5 Stars)</label>
            <select id="edit-testimonial-rating">
                <option value="5">5 Stars</option>
                <option value="4">4 Stars</option>
                <option value="3">3 Stars</option>
                <option value="2">2 Stars</option>
                <option value="1">1 Star</option>
            </select>
          </div>
        </div>
        <div class="form-group" style="margin-top: 1rem;">
          <label for="edit-testimonial-image-url">Author Image URL (Optional)</label>
          <input type="url" id="edit-testimonial-image-url" placeholder="https://example.com/image.jpg">
        </div>
        <button type="submit" class="btn-primary" style="width: 100%; margin-top: 2rem;">Update Testimonial</button>
        <p id="edit-testimonial-status" style="text-align: center; margin-top: 1rem;"></p>
      </form>
    </div>
  </div>

  <!-- Edit Product Modal -->
  <div id="edit-product-modal" class="modal-overlay">
    <div class="modal-content">
      <button id="modal-close-btn" class="modal-close-btn">&times;</button>
      <h2 class="section-title" style="font-size: 2rem; text-align: left; margin-bottom: 2rem;">Edit Product</h2>
      <form id="edit-product-form">
        <input type="hidden" id="edit-product-key">
        <div class="form-grid">
          <div class="form-group">
            <label for="edit-product-name">Product Name</label>
            <input type="text" id="edit-product-name" required>
          </div>
          <div class="form-group">
            <label for="edit-product-price">Price (LKR/mo)</label>
            <input type="number" id="edit-product-price" required>
          </div>
        </div>
        <div class="form-group" style="margin-top: 1rem;">
          <label for="edit-product-description">Description</label>
          <input type="text" id="edit-product-description" required>
        </div>
        <div class="form-group" style="margin-top: 1rem;">
          <label for="edit-product-features">Features (one per line)</label>
          <textarea id="edit-product-features" rows="4" style="padding: 0.75rem; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-family: inherit; font-size: 0.95rem; width: 100%; resize: vertical;"></textarea>
        </div>
        <div class="form-group" style="margin-top: 1rem;">
          <label for="edit-product-image-url">Product Image URL (Optional)</label>
          <input type="url" id="edit-product-image-url" placeholder="https://example.com/image.jpg">
        </div>
        <div class="form-group" style="margin-top: 1rem;">
            <label for="edit-product-featured" style="display: flex; align-items: center; gap: 0.5rem;"><input type="checkbox" id="edit-product-featured" style="width: auto;"> Mark as Featured (Most Popular)</label>
        </div>
        <button type="submit" class="btn-primary" style="width: 100%; margin-top: 2rem;">Update Product</button>
        <p id="edit-product-status" style="text-align: center; margin-top: 1rem;"></p>
      </form>
    </div>
  </div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>

<!-- Firebase Configuration & Admin Logic -->
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDoYwLz6AJRmXZ15e6T0pd13uLEl0Hgd28",
    authDomain: "susara-5d073.firebaseapp.com",
    databaseURL: "https://susara-5d073-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "susara-5d073",
    storageBucket: "susara-5d073.firebasestorage.app",
    messagingSenderId: "260387813251",
    appId: "1:260387813251:web:e1cc7077c43a0b592728b6",
    measurementId: "G-WQWGHL2WSY"
  };
  firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  const db = firebase.database();
  const loginView = document.getElementById('login-view');
  const dashboardView = document.getElementById('admin-dashboard');
  const loginBtn = document.getElementById('login-btn');
  const logoutBtn = document.getElementById('logout-btn');
  const loginError = document.getElementById('login-error');
  const addOrderForm = document.getElementById('add-order-form');
  const orderPlanSelect = document.getElementById('order-plan');
  const orderAmountInput = document.getElementById('order-amount');
  const addOrderStatus = document.getElementById('add-order-status');
  const addProductForm = document.getElementById('add-product-form');
  const productsTableBody = document.getElementById('products-table-body');
  const editProductModal = document.getElementById('edit-product-modal');
  const editProductForm = document.getElementById('edit-product-form');
  const testimonialsTableBody = document.getElementById('testimonials-table-body');
  const editOrderModal = document.getElementById('edit-order-modal');
  const editOrderForm = document.getElementById('edit-order-form');
  const settingsForm = document.getElementById('settings-form');
  const whatsappNumberInput = document.getElementById('whatsapp-number');
  const settingsStatus = document.getElementById('settings-status');
  const teamMembersTableBody = document.getElementById('team-members-table-body');
  const editFreeConfigModal = document.getElementById('edit-free-config-modal');
  const editFreeConfigForm = document.getElementById('edit-free-config-form');
  const freeConfigsTableBody = document.getElementById('free-configs-table-body');
  const messagesTableBody = document.getElementById('messages-table-body');

  // Check auth state
  auth.onAuthStateChanged(user => {
    if (user) {
      loginView.style.display = 'none';
      dashboardView.style.display = 'block';
      logoutBtn.style.display = 'block';
      initializeDashboard(); // Fetch data when user is logged in
      initializeProductManagement();
      initializeTestimonialsManagement();
      initializeSettings();
      initializeTeamManagement();
      initializeMessages();
      initializeFreeConfigs();
    } else {
      loginView.style.display = 'block';
      dashboardView.style.display = 'none';
      logoutBtn.style.display = 'none';
    }
  });
  auth.onAuthStateChanged(user => {
    if (user) {
      loginView.style.display = 'none';
      dashboardView.style.display = 'block';
      logoutBtn.style.display = 'block';
      initializeDashboard(); // Fetch data when user is logged in
      initializeProductManagement();
      initializeTestimonialsManagement();
      initializeSettings();
      initializeTeamManagement();
      initializeMessages();
      initializeFreeConfigs();
    } else {
      loginView.style.display = 'block';
      dashboardView.style.display = 'none';
      logoutBtn.style.display = 'none';
    }
  });

  // Login
  loginBtn.addEventListener('click', () => {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    auth.signInWithEmailAndPassword(email, password)
      .catch(error => {
        loginError.textContent = error.message;
      });
  });

  // Logout
  logoutBtn.addEventListener('click', () => {
    auth.signOut();
  });

  // Auto-update amount based on plan
  const planPrices = {
    "Basic SG V2Ray": 1500,
    "Pro SG V2Ray": 2700,
    "Business SG V2Ray": 4500
  };

  orderPlanSelect.addEventListener('change', (e) => {
    orderAmountInput.value = planPrices[e.target.value];
  });

  // Handle Add Order Form Submission
  addOrderForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const userEmail = document.getElementById('order-email').value;
    const plan = orderPlanSelect.value;
    const amount = parseInt(orderAmountInput.value, 10);

    if (!userEmail || !plan || !amount) {
      addOrderStatus.textContent = "Please fill out all fields.";
      addOrderStatus.style.color = '#ef4444'; // Red
      return;
    }

    const newOrder = {
      orderId: `#A${Math.floor(10000 + Math.random() * 90000)}`,
      userEmail: userEmail,
      plan: plan,
      amount: amount,
      status: 'active', // Default to active
      timestamp: firebase.database.ServerValue.TIMESTAMP
    };

    db.ref('orders').push(newOrder)
      .then(() => {
        addOrderStatus.textContent = "Order added successfully!";
        addOrderStatus.style.color = '#22c55e'; // Green
        addOrderForm.reset();
        // Reset amount to default after form reset
        orderAmountInput.value = planPrices["Pro SG V2Ray"]; 
        setTimeout(() => { addOrderStatus.textContent = ''; }, 3000);
      })
      .catch((error) => {
        console.error("Error adding order: ", error);
        addOrderStatus.textContent = "Error adding order. See console for details.";
        addOrderStatus.style.color = '#ef4444'; // Red
      });
  });

  // Handle Add Product Form Submission
  addProductForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const addProductStatus = document.getElementById('add-product-status');

    const newProduct = {
      name: document.getElementById('product-name').value,
      price: parseInt(document.getElementById('product-price').value, 10),
      description: document.getElementById('product-description').value,
      // Split features by newline and trim whitespace
      features: document.getElementById('product-features').value.split('\n').map(f => f.trim()).filter(f => f),
      isFeatured: false, // Default to not featured
      imageUrl: document.getElementById('product-image-url').value || ''
    };

    if (!newProduct.name || !newProduct.price || !newProduct.description) {
      addProductStatus.textContent = "Please fill out all required fields.";
      addProductStatus.style.color = '#ef4444'; // Red
      return;
    }

    db.ref('products').push(newProduct)
      .then(() => {
        addProductStatus.textContent = "Product added successfully!";
        addProductStatus.style.color = '#22c55e'; // Green
        addProductForm.reset();
        setTimeout(() => { addProductStatus.textContent = ''; }, 3000);
      })
      .catch((error) => {
        console.error("Error adding product: ", error);
        addProductStatus.textContent = "Error adding product. See console for details.";
        addProductStatus.style.color = '#ef4444'; // Red
        if (error.code === 'PERMISSION_DENIED') {
            addProductStatus.textContent += " Please update database rules.";
        }
      });
  });

  // Handle Add Testimonial Form Submission
  document.getElementById('add-testimonial-form').addEventListener('submit', (e) => {
    e.preventDefault();
    const statusEl = document.getElementById('add-testimonial-status');
    const newTestimonial = {
      text: document.getElementById('testimonial-text').value,
      author: document.getElementById('testimonial-author').value,
      location: document.getElementById('testimonial-location').value,
      imageUrl: document.getElementById('testimonial-image-url').value,
      rating: parseInt(document.getElementById('testimonial-rating').value, 10)
    };

    if (!newTestimonial.text || !newTestimonial.author || !newTestimonial.location) {
      statusEl.textContent = "Please fill out all fields.";
      statusEl.style.color = '#ef4444';
      return;
    }

    db.ref('testimonials').push(newTestimonial)
      .then(() => {
        statusEl.textContent = "Testimonial added successfully!";
        statusEl.style.color = '#22c55e';
        document.getElementById('add-testimonial-form').reset();
        setTimeout(() => { statusEl.textContent = ''; }, 3000);
      })
      .catch((error) => {
        console.error("Error adding testimonial: ", error);
        statusEl.textContent = "Error adding testimonial. See console for details.";
        statusEl.style.color = '#ef4444';
        if (error.code === 'PERMISSION_DENIED') {
            statusEl.textContent += " Please update database rules.";
        }
      });
  });

  // Initialize Product Management Table
  function initializeProductManagement() {
    const productsRef = db.ref('products');
    productsRef.on('value', (snapshot) => {
      productsTableBody.innerHTML = '';
      const products = snapshot.val();
      if (products) {
        Object.keys(products).forEach(key => {
          const product = products[key];
          const row = `
            <tr>
              <td>${product.name}</td>
              <td>LKR ${product.price.toLocaleString()}</td>
              <td style="white-space: nowrap;">
                <button class="btn-edit" data-key="${key}">Edit</button>
                <button class="btn-delete" data-key="${key}">Delete</button>
              </td>
            </tr>
          `;
          productsTableBody.innerHTML += row;
        });
      }
    });
  }

  // Event delegation for product action buttons
  productsTableBody.addEventListener('click', (e) => {
    if (e.target.classList.contains('btn-delete')) {
      const productKey = e.target.dataset.key;
      if (confirm('Are you sure you want to delete this product? This action cannot be undone.')) {
        db.ref('products/' + productKey).remove()
          .catch(error => console.error("Error deleting product:", error));
      }
    }
    if (e.target.classList.contains('btn-edit')) {
      const productKey = e.target.dataset.key;
      openEditModal(productKey);
    }
  });

  // Initialize Store Settings
  function initializeSettings() {
    const settingsRef = db.ref('settings');
    
    // Fetch and populate existing settings
    settingsRef.child('whatsappNumber').on('value', (snapshot) => {
        if (snapshot.exists()) {
            whatsappNumberInput.value = snapshot.val();
        }
    });

    // Handle form submission
    settingsForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const newWhatsAppNumber = whatsappNumberInput.value.trim();
        if (newWhatsAppNumber) {
            settingsRef.child('whatsappNumber').set(newWhatsAppNumber)
                .then(() => {
                    settingsStatus.textContent = "Settings saved successfully!";
                    settingsStatus.style.color = '#22c55e';
                    setTimeout(() => { settingsStatus.textContent = ''; }, 3000);
                })
                .catch(error => {
                    settingsStatus.textContent = "Error saving settings.";
                    settingsStatus.style.color = '#ef4444';
                });
        }
    });
  }

  // Handle Add Team Member Form Submission
  document.getElementById('add-team-member-form').addEventListener('submit', (e) => {
    e.preventDefault();
    const statusEl = document.getElementById('add-team-member-status');
    const newMember = {
      name: document.getElementById('team-member-name').value,
      role: document.getElementById('team-member-role').value,
      bio: document.getElementById('team-member-bio').value,
      imageUrl: document.getElementById('team-member-image-url').value
    };

    if (!newMember.name || !newMember.role || !newMember.bio || !newMember.imageUrl) {
      statusEl.textContent = "Please fill out all fields.";
      statusEl.style.color = '#ef4444';
      return;
    }

    db.ref('team').push(newMember)
      .then(() => {
        statusEl.textContent = "Team member added successfully!";
        statusEl.style.color = '#22c55e';
        document.getElementById('add-team-member-form').reset();
        setTimeout(() => { statusEl.textContent = ''; }, 3000);
      })
      .catch((error) => {
        console.error("Error adding team member: ", error);
        statusEl.textContent = "Error adding team member. See console for details.";
        statusEl.style.color = '#ef4444';
        if (error.code === 'PERMISSION_DENIED') {
            statusEl.textContent += " Please update database rules.";
        }
      });
  });


  // Initialize Testimonials Management Table
  function initializeTestimonialsManagement() {
    const testimonialsRef = db.ref('testimonials');
    testimonialsRef.on('value', (snapshot) => {
      testimonialsTableBody.innerHTML = '';
      const testimonials = snapshot.val();
      if (testimonials) {
        Object.keys(testimonials).forEach(key => {
          const testimonial = testimonials[key];
          const row = `
            <tr>
              <td>${testimonial.author}</td>
              <td>${testimonial.text.substring(0, 100)}...</td>
              <td style="white-space: nowrap;">
                <button class="btn-edit" data-testimonial-key="${key}">Edit</button>
                <button class="btn-delete" data-testimonial-key="${key}">Delete</button>
              </td>
            </tr>
          `;
          testimonialsTableBody.innerHTML += row;
        });
      }
    });
  }

  // Event delegation for testimonial action buttons
  testimonialsTableBody.addEventListener('click', (e) => {
    const target = e.target;
    const testimonialKey = target.dataset.testimonialKey;
    if (!testimonialKey) return;

    if (target.classList.contains('btn-delete')) {
      if (confirm('Are you sure you want to delete this testimonial?')) {
        db.ref('testimonials/' + testimonialKey).remove()
          .catch(error => console.error("Error deleting testimonial:", error));
      }
    } else if (target.classList.contains('btn-edit')) {
      openEditTestimonialModal(testimonialKey);
    }
  });

  // --- Edit Testimonial Modal Logic ---
  const editTestimonialModal = document.getElementById('edit-testimonial-modal');
  const editTestimonialForm = document.getElementById('edit-testimonial-form');

  function openEditTestimonialModal(key) {
    db.ref('testimonials/' + key).once('value').then((snapshot) => {
      const testimonial = snapshot.val();
      if (testimonial) {
        document.getElementById('edit-testimonial-key').value = key;
        document.getElementById('edit-testimonial-text').value = testimonial.text;
        document.getElementById('edit-testimonial-author').value = testimonial.author;
        document.getElementById('edit-testimonial-location').value = testimonial.location;
        document.getElementById('edit-testimonial-image-url').value = testimonial.imageUrl || '';
        document.getElementById('edit-testimonial-rating').value = testimonial.rating || 5;
        editTestimonialModal.style.display = 'flex';
      }
    });
  }

  function closeEditTestimonialModal() {
    editTestimonialModal.style.display = 'none';
  }

  document.getElementById('testimonial-modal-close-btn').addEventListener('click', closeEditTestimonialModal);

  editTestimonialForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const key = document.getElementById('edit-testimonial-key').value;
    const updatedTestimonial = {
      text: document.getElementById('edit-testimonial-text').value,
      author: document.getElementById('edit-testimonial-author').value,
      location: document.getElementById('edit-testimonial-location').value,
      imageUrl: document.getElementById('edit-testimonial-image-url').value,
      rating: parseInt(document.getElementById('edit-testimonial-rating').value, 10)
    };
    db.ref('testimonials/' + key).update(updatedTestimonial).then(closeEditTestimonialModal);
  });

  // Initialize Team Management Table
  function initializeTeamManagement() {
    const teamRef = db.ref('team');
    teamRef.on('value', (snapshot) => {
      teamMembersTableBody.innerHTML = '';
      const team = snapshot.val();
      if (team) {
        Object.keys(team).forEach(key => {
          const member = team[key];
          const row = `
            <tr>
              <td>${member.name}</td>
              <td>${member.role}</td>
              <td style="white-space: nowrap;">
                <button class="btn-delete" data-team-key="${key}">Delete</button>
              </td>
            </tr>
          `;
          teamMembersTableBody.innerHTML += row;
        });
      }
    });
  }

  // Event delegation for team action buttons
  teamMembersTableBody.addEventListener('click', (e) => {
    const target = e.target;
    const teamKey = target.dataset.teamKey;
    if (!teamKey) return;

    if (target.classList.contains('btn-delete')) {
      if (confirm('Are you sure you want to delete this team member?')) {
        db.ref('team/' + teamKey).remove()
          .catch(error => console.error("Error deleting team member:", error));
      }
    }
    // Note: Edit functionality for team members is not included in this step but could be added similarly to products/testimonials.
  });

  // Handle Add Free Config Form Submission
  document.getElementById('add-free-config-form').addEventListener('submit', (e) => {
    e.preventDefault();
    const statusEl = document.getElementById('add-free-config-status');
    const newConfig = {
      name: document.getElementById('free-config-name').value,
      description: document.getElementById('free-config-desc').value,
      configUrl: document.getElementById('free-config-url').value
    };

    if (!newConfig.name || !newConfig.configUrl) {
      statusEl.textContent = "Name and URL are required.";
      statusEl.style.color = '#ef4444';
      return;
    }

    db.ref('freeConfigs').push(newConfig)
      .then(() => {
        statusEl.textContent = "Free config added successfully!";
        statusEl.style.color = '#22c55e';
        document.getElementById('add-free-config-form').reset();
        setTimeout(() => { statusEl.textContent = ''; }, 3000);
      })
      .catch((error) => {
        console.error("Error adding free config: ", error);
        statusEl.textContent = "Error adding free config. See console.";
        statusEl.style.color = '#ef4444';
      });
  });

  // Initialize Free Configs Management Table
  function initializeFreeConfigs() {
    const freeConfigsRef = db.ref('freeConfigs');
    freeConfigsRef.on('value', (snapshot) => {
      freeConfigsTableBody.innerHTML = '';
      const configs = snapshot.val();
      if (configs) {
        Object.keys(configs).forEach(key => {
          const config = configs[key];
          const row = `
            <tr>
              <td>${config.name}</td>
              <td style="white-space: nowrap;">
                <button class="btn-edit" data-free-config-key="${key}">Edit</button>
                <button class="btn-delete" data-free-config-key="${key}">Delete</button>
              </td>
            </tr>
          `;
          freeConfigsTableBody.innerHTML += row;
        });
      }
    });
  }

  // Event delegation for free config delete buttons
  freeConfigsTableBody.addEventListener('click', (e) => {
    const target = e.target;
    const configKey = target.dataset.freeConfigKey;
    if (!configKey) return;

    if (target.classList.contains('btn-delete')) {
      if (confirm('Are you sure you want to delete this free config?')) {
        db.ref('freeConfigs/' + configKey).remove();
      }
    } else if (target.classList.contains('btn-edit')) {
      openEditFreeConfigModal(configKey);
    }
  });

  // --- Edit Free Config Modal Logic ---
  function openEditFreeConfigModal(key) {
    db.ref('freeConfigs/' + key).once('value').then((snapshot) => {
      const config = snapshot.val();
      if (config) {
        document.getElementById('edit-free-config-key').value = key;
        document.getElementById('edit-free-config-name').value = config.name;
        document.getElementById('edit-free-config-desc').value = config.description;
        document.getElementById('edit-free-config-url').value = config.configUrl;
        editFreeConfigModal.style.display = 'flex';
      }
    });
  }

  function closeEditFreeConfigModal() {
    editFreeConfigModal.style.display = 'none';
  }

  document.getElementById('free-config-modal-close-btn').addEventListener('click', closeEditFreeConfigModal);

  editFreeConfigForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const key = document.getElementById('edit-free-config-key').value;
    const updatedConfig = {
      name: document.getElementById('edit-free-config-name').value,
      description: document.getElementById('edit-free-config-desc').value,
      configUrl: document.getElementById('edit-free-config-url').value,
    };
    db.ref('freeConfigs/' + key).update(updatedConfig)
      .then(() => {
        const statusEl = document.getElementById('edit-free-config-status');
        statusEl.textContent = "Config updated successfully!";
        statusEl.style.color = '#22c55e';
        setTimeout(closeEditFreeConfigModal, 1500);
      })
      .catch(error => console.error("Error updating config:", error));
  });

  // Initialize Messages Table
  function initializeMessages() {
      const messagesRef = db.ref('messages').orderByChild('timestamp');
      messagesRef.on('value', (snapshot) => {
          messagesTableBody.innerHTML = '';
          const messages = [];
          snapshot.forEach(child => {
              messages.push({ key: child.key, ...child.val() });
          });

          messages.reverse().forEach(msg => {
              const isReadClass = msg.isRead ? 'is-read' : '';
              const row = `
                  <tr class="${isReadClass}">
                      <td>${msg.name}</td>
                      <td>${msg.email}</td>
                      <td>${msg.message}</td>
                      <td style="white-space: nowrap;">
                          ${!msg.isRead ? `<button class="btn-edit" data-message-key="${msg.key}">Mark as Read</button>` : ''}
                          <button class="btn-delete" data-message-key="${msg.key}">Delete</button>
                      </td>
                  </tr>
              `;
              messagesTableBody.innerHTML += row;
          });
      });
  }

  // Event delegation for message action buttons
  messagesTableBody.addEventListener('click', (e) => {
      const target = e.target;
      const messageKey = target.dataset.messageKey;
      if (!messageKey) return;

      if (target.classList.contains('btn-edit')) { // Reusing 'btn-edit' style
          db.ref('messages/' + messageKey).update({ isRead: true })
              .catch(error => console.error("Error marking message as read:", error));
      } else if (target.classList.contains('btn-delete')) {
          if (confirm('Are you sure you want to permanently delete this message?')) {
              db.ref('messages/' + messageKey).remove()
              .catch(error => console.error("Error marking message as read:", error));
          }
      }
  });


  // --- Edit Product Modal Logic ---
  function openEditModal(productKey) {
    db.ref('products/' + productKey).once('value').then((snapshot) => {
      const product = snapshot.val();
      if (product) {
        document.getElementById('edit-product-key').value = productKey;
        document.getElementById('edit-product-name').value = product.name;
        document.getElementById('edit-product-price').value = product.price;
        document.getElementById('edit-product-description').value = product.description;
        document.getElementById('edit-product-features').value = product.features ? product.features.join('\n') : '';
        document.getElementById('edit-product-image-url').value = product.imageUrl || '';
        document.getElementById('edit-product-featured').checked = product.isFeatured || false;
        editProductModal.style.display = 'flex';
      }
    });
  }

  function closeEditModal() {
    editProductModal.style.display = 'none';
    document.getElementById('edit-product-status').textContent = '';
  }

  document.getElementById('modal-close-btn').addEventListener('click', closeEditModal);
  editProductModal.addEventListener('click', (e) => {
    if (e.target === editProductModal) { // Close if clicking on overlay
      closeEditModal();
    }
  });

  editProductForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const productKey = document.getElementById('edit-product-key').value;
    const updatedProduct = {
      name: document.getElementById('edit-product-name').value,
      price: parseInt(document.getElementById('edit-product-price').value, 10),
      description: document.getElementById('edit-product-description').value,
      features: document.getElementById('edit-product-features').value.split('\n').map(f => f.trim()).filter(f => f),
      isFeatured: document.getElementById('edit-product-featured').checked,
      imageUrl: document.getElementById('edit-product-image-url').value || ''
    };

    db.ref('products/' + productKey).update(updatedProduct)
      .then(() => {
        const statusEl = document.getElementById('edit-product-status');
        statusEl.textContent = "Product updated successfully!";
        statusEl.style.color = '#22c55e';
        setTimeout(closeEditModal, 1500);
      })
      .catch(error => {
        console.error("Error updating product:", error);
      });
  });

  // --- Edit Order Modal Logic ---
  function openEditOrderModal(orderKey) {
    db.ref('orders/' + orderKey).once('value').then((snapshot) => {
      const order = snapshot.val();
      if (order) {
        document.getElementById('edit-order-key').value = orderKey;
        document.getElementById('edit-order-id').value = order.orderId;
        document.getElementById('edit-order-email').value = order.userEmail;
        document.getElementById('edit-order-amount').value = order.amount;
        document.getElementById('edit-order-status-select').value = order.status;
        editOrderModal.style.display = 'flex';
      }
    });
  }

  function closeEditOrderModal() {
    editOrderModal.style.display = 'none';
    document.getElementById('update-order-status').textContent = '';
  }

  document.getElementById('order-modal-close-btn').addEventListener('click', closeEditOrderModal);

  editOrderForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const orderKey = document.getElementById('edit-order-key').value;
    const updatedOrder = {
      userEmail: document.getElementById('edit-order-email').value,
      amount: parseInt(document.getElementById('edit-order-amount').value, 10),
      status: document.getElementById('edit-order-status-select').value
    };

    db.ref('orders/' + orderKey).update(updatedOrder)
      .then(() => {
        const statusEl = document.getElementById('update-order-status');
        statusEl.textContent = "Order updated successfully!";
        statusEl.style.color = '#22c55e';
        setTimeout(closeEditOrderModal, 1500);
      })
      .catch(error => {
        console.error("Error updating order:", error);
      });
  });

  // Event delegation for order action buttons
  document.getElementById('orders-table-body').addEventListener('click', (e) => {
    if (e.target.classList.contains('btn-edit')) {
      const orderId = e.target.dataset.key;
      // To get the Firebase key, we need to query for it.
      // This is a bit more complex than for products, as we only have the orderId.
      db.ref('orders').orderByChild('orderId').equalTo(orderId).once('value', snapshot => {
          if(snapshot.exists()){
              const firebaseKey = Object.keys(snapshot.val())[0];
              openEditOrderModal(firebaseKey);
          }
      });
    }
  });

  // Fetch and display recent orders
  function initializeDashboard() {
    const ordersRef = db.ref('orders').orderByChild('timestamp');
    const tableBody = document.getElementById('orders-table-body');
    const totalUsersStat = document.getElementById('total-users-stat');
    const monthlyRevenueStat = document.getElementById('monthly-revenue-stat');
    const activeSubsStat = document.getElementById('active-subs-stat');

    ordersRef.on('value', (snapshot) => {
      const orders = [];
      snapshot.forEach((childSnapshot) => {
        orders.push(childSnapshot.val());
      });

      // --- 1. Update Dashboard Stats ---
      let monthlyRevenue = 0;
      let activeSubs = 0;
      const uniqueUsers = new Set();
      const now = new Date();
      const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1).getTime();

      orders.forEach(order => {
        uniqueUsers.add(order.userEmail);
        if (order.status === 'active') {
          activeSubs++;
        }
        if (order.timestamp >= startOfMonth) {
          monthlyRevenue += order.amount;
        }
      });

      totalUsersStat.textContent = uniqueUsers.size;
      monthlyRevenueStat.textContent = `LKR ${monthlyRevenue.toLocaleString()}`;
      activeSubsStat.textContent = activeSubs;

      // --- 2. Update Recent Orders Table ---
      tableBody.innerHTML = ''; // Clear existing rows
      const recentOrders = orders.slice(-10).reverse(); // Get last 10 and reverse

      recentOrders.forEach(order => {
        if (!order) return; // Skip if order is null/undefined
        const statusClass = order.status === 'active' ? 'status-active' : 'status-pending';
        const row = `
          <tr>
            <td>${order.orderId}</td>
            <td>${order.userEmail}</td>
            <td>${order.plan}</td>
            <td>LKR ${order.amount ? order.amount.toLocaleString() : '0'}</td>
            <td><span class="status-badge ${statusClass}">${order.status}</span></td>
            <td>
                <button class="btn-edit" data-key="${order.orderId}">Edit</button>
            </td>
          </tr>
        `;
        tableBody.innerHTML += row;
      });
    }, (error) => {
      console.error("Error fetching orders: ", error);
      tableBody.innerHTML = `<tr><td colspan="5" style="text-align: center;">Could not fetch data.</td></tr>`;
    });
  }
</script>
<script>
  // --- Tab Navigation Logic ---
  const adminNav = document.getElementById('admin-nav');
  const contentSections = document.querySelectorAll('.content-section');
  
  adminNav.addEventListener('click', (e) => {
    if (e.target.tagName === 'A') {
      e.preventDefault();
      const targetId = e.target.dataset.target;

      // Update active link
      adminNav.querySelectorAll('a').forEach(link => link.classList.remove('active'));
      e.target.classList.add('active');

      // Show target content
      contentSections.forEach(section => section.classList.toggle('active', section.id === targetId));
    }
  });
</script>

</body>
</html>